@model DMS_CPMS.Models.Patient.PatientDocumentsIndexViewModel

@{
    ViewData["Title"] = "Patient Document Management";
}

<div class="container-fluid">
    <!-- Patient Profile Summary -->
    <div class="card shadow-sm border-0 mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Patient Profile Summary</h5>
            <div class="row gx-3">
                <div class="col">
                    <small class="text-muted d-block">First Name</small>
                    <span class="fw-medium d-block">@Model.Patient.FirstName</span>
                </div>
                <div class="col">
                    <small class="text-muted d-block text-center">Last Name</small>
                    <span class="fw-medium d-block text-center">@Model.Patient.LastName</span>
                </div>
                <div class="col">
                    <small class="text-muted d-block text-center">Gender</small>
                    <span class="fw-medium d-block text-center">@Model.Patient.Gender</span>
                </div>
                <div class="col">
                    <small class="text-muted d-block text-center">Age</small>
                    <span class="fw-medium d-block text-center">@Model.PatientAge</span>
                </div>
                <div class="col">
                    <small class="text-muted d-block text-center">Last Visit</small>
                    <span class="fw-medium d-block text-center">@Model.Patient.VisitedAt.ToString("yyyy-MM-dd")</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Upload Document Button - Outside Table Container -->
    <div class="d-flex justify-content-start mb-2">
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadDocumentModal">
            Upload Document
        </button>
    </div>

    <!-- Document Management Section -->
    <div class="card shadow-sm border-0 mb-3">
        
        <div class="card-body">
            <!-- Search & Filters -->
            <form class="row g-2 align-items-end mb-3" method="get" asp-action="Index" asp-controller="PatientDocuments">
                <input type="hidden" name="patientId" value="@Model.Patient.PatientID" />
                <div class="col-md-4">
                    <label class="form-label">Search by name</label>
                    <input type="text" name="searchTerm" value="@Model.SearchTerm" class="form-control" placeholder="Enter document name" />
                </div>
                <div class="col-md-3">
                    <label class="form-label">Document Type</label>
                    <select name="documentType" class="form-select">
                        <option value="">All</option>
                        <option value="Medical Record" selected="@(Model.DocumentTypeFilter == "Medical Record" ? "selected" : null)">Medical Record</option>
                        <option value="Lab Result" selected="@(Model.DocumentTypeFilter == "Lab Result" ? "selected" : null)">Lab Result</option>
                        <option value="Prescription" selected="@(Model.DocumentTypeFilter == "Prescription" ? "selected" : null)">Prescription</option>
                        <option value="Other" selected="@(Model.DocumentTypeFilter == "Other" ? "selected" : null)">Other</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <button type="submit" class="btn btn-secondary me-2">Filter</button>
                    <a asp-action="Index" asp-controller="PatientDocuments" asp-route-patientId="@Model.Patient.PatientID" class="btn btn-outline-secondary">Reset</a>
                </div>
            </form>

            <!-- Documents Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover align-middle mb-0">
                    <thead class="table-header-ocean">
                        <tr>
                            <th style="width: 20%;">Document Name</th>
                            <th style="width: 12%;">Document Type</th>
                            <th style="width: 10%;">Version</th>
                            <th style="width: 13%;">Uploaded By</th>
                            <th style="width: 13%;">Upload Date</th>
                            <th style="width: 10%;">Status</th>
                            <th style="width: 22%;">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @if (!Model.Documents.Any())
                        {
                            <tr>
                                <td colspan="7" class="text-center text-muted py-4">
                                    No documents found. Use the button above to upload a new document.
                                </td>
                            </tr>
                        }
                        else
                        {
                            foreach (var doc in Model.Documents)
                            {
                                <tr>
                                    <td>@doc.DocumentName</td>
                                    <td>@doc.DocumentType</td>
                                    <td>@doc.Version</td>
                                    <td>@doc.UploadedBy</td>
                                    <td>@doc.UploadDate.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <span class="badge bg-secondary">@doc.Status</span>
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1 flex-wrap">
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="viewDocument(@doc.DocumentID, '@doc.DocumentName')">View</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editDocumentModal" onclick="openEditModal(@doc.DocumentID, '@doc.DocumentName', '@doc.DocumentType')">Edit</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary" onclick="showVersionHistory(@doc.DocumentID, '@doc.DocumentName')">Version</button>
                                            <button type="button" class="btn btn-sm btn-outline-secondary">Archive</button>
                                        </div>
                                    </td>
                                </tr>
                            }
                        }
                    </tbody>
                </table>
            </div>

            @if (Model.TotalPages > 1)
            {
                <nav class="mt-3">
                    <ul class="pagination pagination-sm mb-0">
                        <li class="page-item @(Model.PageNumber == 1 ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-controller="PatientDocuments" asp-route-patientId="@Model.Patient.PatientID" asp-route-page="@(Model.PageNumber - 1)" asp-route-searchTerm="@Model.SearchTerm" asp-route-documentType="@Model.DocumentTypeFilter">Previous</a>
                        </li>
                        @for (var i = 1; i <= Model.TotalPages; i++)
                        {
                            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                                <a class="page-link" asp-action="Index" asp-controller="PatientDocuments" asp-route-patientId="@Model.Patient.PatientID" asp-route-page="@i" asp-route-searchTerm="@Model.SearchTerm" asp-route-documentType="@Model.DocumentTypeFilter">@i</a>
                            </li>
                        }
                        <li class="page-item @(Model.PageNumber == Model.TotalPages ? "disabled" : "")">
                            <a class="page-link" asp-action="Index" asp-controller="PatientDocuments" asp-route-patientId="@Model.Patient.PatientID" asp-route-page="@(Model.PageNumber + 1)" asp-route-searchTerm="@Model.SearchTerm" asp-route-documentType="@Model.DocumentTypeFilter">Next</a>
                        </li>
                    </ul>
                </nav>
            }
        </div>
    </div>
</div>

<!-- View Document Modal -->
<div class="modal fade" id="viewDocumentModal" tabindex="-1" aria-labelledby="viewDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content ocean-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="viewDocumentModalLabel">View Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center" id="viewDocumentModalBody">
                <p class="text-muted mb-0">Loading document...</p>
            </div>
            <div class="modal-footer">
                <a id="viewDocumentDownloadLink" href="#" class="btn btn-primary">Download</a>
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Document Modal -->
<div class="modal fade" id="editDocumentModal" tabindex="-1" aria-labelledby="editDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content ocean-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="editDocumentModalLabel">Edit Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Edit" asp-controller="PatientDocuments" method="post">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" id="editDocumentId" name="DocumentID" />
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Document Title</label>
                            <input type="text" id="editDocumentTitle" name="DocumentTitle" class="form-control" required maxlength="100" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Document Type</label>
                            <select id="editDocumentType" name="DocumentType" class="form-select" required>
                                <option value="">Select document type</option>
                                <option value="Medical Record">Medical Record</option>
                                <option value="Lab Result">Lab Result</option>
                                <option value="Prescription">Prescription</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12" id="editOtherTypeContainer" style="display: none;">
                            <label class="form-label">Please specify:</label>
                            <input type="text" id="editOtherDocumentType" name="OtherDocumentType" class="form-control" maxlength="30" placeholder="Enter document type (max 30 chars)" />
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Version History Modal -->
<div class="modal fade" id="versionHistoryModal" tabindex="-1" aria-labelledby="versionHistoryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content ocean-modal">
            <div class="modal-header">
                <div>
                    <h5 class="modal-title mb-0" id="versionHistoryModalLabel">Document Version History</h5>
                    <p class="text-muted mb-0 mt-1" id="versionHistoryDocumentName"></p>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="versionHistoryModalBody">
                <p class="text-muted">Loading version history...</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Upload Document Modal -->
<div class="modal fade" id="uploadDocumentModal" tabindex="-1" aria-labelledby="uploadDocumentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content ocean-modal">
            <div class="modal-header">
                <h5 class="modal-title" id="uploadDocumentModalLabel">Upload Document</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form asp-action="Upload" asp-controller="PatientDocuments" method="post" enctype="multipart/form-data">
                <div class="modal-body">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="PatientID" value="@Model.Patient.PatientID" />
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label">Document Title</label>
                            <input type="text" name="DocumentTitle" class="form-control" required maxlength="100" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Document Type</label>
                            <select name="DocumentType" id="documentTypeSelect" class="form-select" required>
                                <option value="">Select document type</option>
                                <option value="Medical Record">Medical Record</option>
                                <option value="Lab Result">Lab Result</option>
                                <option value="Prescription">Prescription</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="col-12" id="otherTypeContainer" style="display: none;">
                            <label class="form-label">Please specify:</label>
                            <input type="text" name="OtherDocumentType" id="otherDocumentType" class="form-control" maxlength="30" placeholder="Enter document type (max 30 chars)" />
                        </div>
                        <div class="col-12">
                            <label class="form-label">Select File</label>
                            <input type="file" name="UploadedFile" class="form-control" required />
                            <small class="text-muted d-block mt-1">Allowed file types: PDF, JPG, PNG, CSV.</small>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Upload</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            // Document type conditional field for Upload
            var documentTypeSelect = document.getElementById('documentTypeSelect');
            var otherTypeContainer = document.getElementById('otherTypeContainer');
            var otherDocumentType = document.getElementById('otherDocumentType');

            if (documentTypeSelect && otherTypeContainer) {
                documentTypeSelect.addEventListener('change', function () {
                    if (this.value === 'Other') {
                        otherTypeContainer.style.display = 'block';
                        otherDocumentType.setAttribute('required', 'required');
                    } else {
                        otherTypeContainer.style.display = 'none';
                        otherDocumentType.removeAttribute('required');
                        otherDocumentType.value = '';
                    }
                });
            }

            // Document type conditional field for Edit
            var editDocumentType = document.getElementById('editDocumentType');
            var editOtherTypeContainer = document.getElementById('editOtherTypeContainer');
            var editOtherDocumentType = document.getElementById('editOtherDocumentType');

            if (editDocumentType && editOtherTypeContainer) {
                editDocumentType.addEventListener('change', function () {
                    if (this.value === 'Other') {
                        editOtherTypeContainer.style.display = 'block';
                        editOtherDocumentType.setAttribute('required', 'required');
                    } else {
                        editOtherTypeContainer.style.display = 'none';
                        editOtherDocumentType.removeAttribute('required');
                        editOtherDocumentType.value = '';
                    }
                });
            }

            // View Document Modal
            window.viewDocument = function (documentId, documentName) {
                var modal = document.getElementById('viewDocumentModal');
                var modalTitle = document.getElementById('viewDocumentModalLabel');
                var modalBody = document.getElementById('viewDocumentModalBody');
                var downloadLink = document.getElementById('viewDocumentDownloadLink');

                if (modalTitle) modalTitle.textContent = documentName || 'View Document';
                if (modalBody) modalBody.innerHTML = '<p class="text-muted mb-0">Loading document...</p>';
                if (downloadLink) downloadLink.href = '/PatientDocuments/Download?id=' + encodeURIComponent(documentId);

                var bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                // Fetch file info
                fetch('/PatientDocuments/GetFileInfo?id=' + encodeURIComponent(documentId))
                    .then(function (response) {
                        if (!response.ok) throw new Error('Failed to load document info');
                        return response.json();
                    })
                    .then(function (data) {
                        if (!modalBody) return;

                        if (data.isImage) {
                            modalBody.innerHTML = '<img src="' + data.filePath + '" alt="' + (documentName || 'Document') + '" class="img-fluid" style="max-height: 70vh;" />';
                        } else if (data.isPdf) {
                            modalBody.innerHTML = '<iframe src="' + data.filePath + '" width="100%" height="500px" style="border: none;"></iframe>';
                        } else {
                            modalBody.innerHTML = '<div class="alert alert-info"><p>This file type cannot be previewed. Please download the file to view it.</p><p class="mb-0"><strong>File:</strong> ' + (documentName || 'Document') + '<br><strong>Type:</strong> ' + (data.fileExtension || 'Unknown') + '</p></div>';
                        }
                    })
                    .catch(function (error) {
                        if (modalBody) {
                            modalBody.innerHTML = '<div class="alert alert-danger">Failed to load document. Please try again.</div>';
                        }
                    });
            };

            // Edit Document Modal
            window.openEditModal = function (documentId, documentName, documentType) {
                var idInput = document.getElementById('editDocumentId');
                var titleInput = document.getElementById('editDocumentTitle');
                var typeSelect = document.getElementById('editDocumentType');
                var otherContainer = document.getElementById('editOtherTypeContainer');
                var otherInput = document.getElementById('editOtherDocumentType');

                if (idInput) idInput.value = documentId;
                if (titleInput) titleInput.value = documentName || '';

                // Handle "Other - xxx" document types
                if (documentType && documentType.startsWith('Other - ')) {
                    if (typeSelect) typeSelect.value = 'Other';
                    if (otherContainer) otherContainer.style.display = 'block';
                    if (otherInput) {
                        otherInput.value = documentType.substring(8);
                        otherInput.setAttribute('required', 'required');
                    }
                } else {
                    if (typeSelect) typeSelect.value = documentType || '';
                    if (otherContainer) otherContainer.style.display = 'none';
                    if (otherInput) {
                        otherInput.value = '';
                        otherInput.removeAttribute('required');
                    }
                }
            };

            // Version History Modal
            window.showVersionHistory = function (documentId, documentName) {
                var modal = document.getElementById('versionHistoryModal');
                var modalLabel = document.getElementById('versionHistoryModalLabel');
                var docNameEl = document.getElementById('versionHistoryDocumentName');
                var modalBody = document.getElementById('versionHistoryModalBody');

                if (modalLabel) modalLabel.textContent = 'Document Version History';
                if (docNameEl) docNameEl.textContent = documentName || '';
                if (modalBody) modalBody.innerHTML = '<p class="text-muted">Loading version history...</p>';

                var bsModal = new bootstrap.Modal(modal);
                bsModal.show();

                // Fetch version history
                fetch('/PatientDocuments/GetVersionHistory?id=' + encodeURIComponent(documentId))
                    .then(function (response) {
                        if (!response.ok) {
                            console.error('Version history fetch failed:', response.status, response.statusText);
                            throw new Error('Failed to load version history: ' + response.status);
                        }
                        return response.json();
                    })
                    .then(function (data) {
                        console.log('Version history data:', data);
                        if (!modalBody) return;

                        if (!data.versions || data.versions.length === 0) {
                            modalBody.innerHTML = '<p class="text-muted">No version history available.</p>';
                            return;
                        }

                        var html = '<div class="version-timeline">';
                        data.versions.forEach(function (version, index) {
                            var isLast = index === data.versions.length - 1;
                            html += '<div class="d-flex gap-3">';
                            html += '  <div class="d-flex flex-column align-items-center">';
                            html += '    <div class="rounded-circle bg-secondary" style="width: 12px; height: 12px;"></div>';
                            if (!isLast) {
                                html += '    <div class="bg-secondary" style="width: 2px; flex-grow: 1; margin-top: 4px;"></div>';
                            }
                            html += '  </div>';
                            html += '  <div class="flex-grow-1 pb-4">';
                            html += '    <div class="bg-light border rounded p-3">';
                            html += '      <div class="d-flex justify-content-between align-items-center mb-2">';
                            html += '        <div class="d-flex align-items-center gap-2">';
                            html += '          <span class="badge bg-secondary">' + version.version + '</span>';
                            html += '          <span>' + version.modifiedBy + '</span>';
                            html += '        </div>';
                            html += '        <span class="text-muted small">' + version.dateModified + '</span>';
                            html += '      </div>';
                            html += '      <p class="text-muted small mb-2">' + (version.notes || 'No notes') + '</p>';
                            html += '      <div class="d-flex gap-2">';
                            html += '        <button class="btn btn-sm btn-outline-secondary" onclick="viewVersionDocument(' + version.versionID + ', \'' + (documentName || 'Document').replace(/'/g, "\\'") + '\')">View</button>';
                            html += '        <a href="/PatientDocuments/DownloadVersion?versionId=' + version.versionID + '" class="btn btn-sm btn-outline-secondary">Download</a>';
                            if (index > 0) {
                                html += '        <button class="btn btn-sm btn-outline-secondary">Restore</button>';
                            }
                            html += '      </div>';
                            html += '    </div>';
                            html += '  </div>';
                            html += '</div>';
                        });
                        html += '</div>';

                        modalBody.innerHTML = html;
                    })
                    .catch(function (error) {
                        if (modalBody) {
                            modalBody.innerHTML = '<div class="alert alert-danger">Failed to load version history. Please try again.</div>';
                        }
                    });
            };
        })();
    </script>
}

@model DMS_CPMS.Models.Staff.StaffDashboardViewModel
@{
    ViewData["Title"] = "Staff Dashboard";
}

<div class="container-fluid staff-dashboard">
    <!-- ─── Date Range Filter ─── -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="dash-filter-bar">
                <div class="dash-filter-group" role="group" aria-label="Date Range Filter">
                    <button type="button" class="dash-filter-btn active" data-range="all">All Time</button>
                    <button type="button" class="dash-filter-btn" data-range="today">Today</button>
                    <button type="button" class="dash-filter-btn" data-range="7days">Last 7 Days</button>
                    <button type="button" class="dash-filter-btn" data-range="30days">Last 30 Days</button>
                    <button type="button" class="dash-filter-btn" data-range="custom" id="btnCustomRange">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;vertical-align:-2px;margin-right:3px;">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                        </svg>Custom
                    </button>
                </div>
                <!-- Hidden Custom Date Fields -->
                <div class="dash-custom-date-fields" id="customDateFields" style="display: none;">
                    <div class="dash-date-input">
                        <label for="customStartDate">From</label>
                        <input type="date" id="customStartDate" class="form-control form-control-sm">
                    </div>
                    <div class="dash-date-input">
                        <label for="customEndDate">To</label>
                        <input type="date" id="customEndDate" class="form-control form-control-sm">
                    </div>
                    <button type="button" class="dash-apply-btn" id="applyCustomDate">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ─── KPI Cards ─── -->
    <div class="row g-3 mb-4">
        <div class="col-xl-3 col-md-6">
            <div class="dash-kpi-card">
                <div class="dash-kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/>
                    </svg>
                </div>
                <div class="dash-kpi-body">
                    <span class="dash-kpi-number" id="kpiTotalDocs">@Model.TotalDocuments</span>
                    <span class="dash-kpi-label">Total Documents</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-kpi-card">
                <div class="dash-kpi-icon" style="background: rgba(131,197,190,0.15); color: var(--color-accent);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5" rx="1"/><line x1="10" y1="12" x2="14" y2="12"/>
                    </svg>
                </div>
                <div class="dash-kpi-body">
                    <span class="dash-kpi-number" id="kpiTotalArchived">@Model.TotalArchived</span>
                    <span class="dash-kpi-label">Total Archived</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-kpi-card">
                <div class="dash-kpi-icon" style="background: rgba(0,86,96,0.10); color: var(--color-primary-dark);">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/>
                    </svg>
                </div>
                <div class="dash-kpi-body">
                    <span class="dash-kpi-number" id="kpiTotalVersions">@Model.TotalVersions</span>
                    <span class="dash-kpi-label">Total Versions</span>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="dash-kpi-card">
                <div class="dash-kpi-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/>
                    </svg>
                </div>
                <div class="dash-kpi-body">
                    <span class="dash-kpi-number" id="kpiDocsMonth">@Model.DocumentsUploadedThisMonth</span>
                    <span class="dash-kpi-label">Uploaded This Month</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ─── Charts Row 1: Line Chart + Bar Chart ─── -->
    <div class="row g-3 mb-4">
        <div class="col-lg-7">
            <div class="dash-chart-card">
                <div class="dash-chart-header">
                    <h6 class="mb-0 fw-semibold" id="trendChartTitle">Monthly Document Upload Trend</h6>
                </div>
                <div class="dash-chart-body">
                    <canvas id="uploadTrendChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-5">
            <div class="dash-chart-card">
                <div class="dash-chart-header">
                    <h6 class="mb-0 fw-semibold">Document Type Distribution</h6>
                </div>
                <div class="dash-chart-body">
                    <canvas id="docTypeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ─── Charts Row 2: Donut Chart + Recent Activity ─── -->
    <div class="row g-3 mb-4">
        <div class="col-lg-4">
            <div class="dash-chart-card">
                <div class="dash-chart-header">
                    <h6 class="mb-0 fw-semibold">Active vs Archived</h6>
                </div>
                <div class="dash-chart-body d-flex align-items-center justify-content-center" style="min-height: 280px;">
                    <canvas id="activeArchivedChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-lg-8">
            <div class="dash-chart-card">
                <div class="dash-chart-header d-flex align-items-center justify-content-between">
                    <h6 class="mb-0 fw-semibold">Recent Activity</h6>
                    <small class="text-muted" id="activityCount">Showing latest @Model.RecentActivities.Count entries</small>
                </div>
                <div class="dash-chart-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle mb-0" id="activityTable">
                            <thead>
                                <tr>
                                    <th class="ps-3">Document</th>
                                    <th>Patient</th>
                                    <th>Action</th>
                                    <th>Date</th>
                                    <th>Performed By</th>
                                </tr>
                            </thead>
                            <tbody id="activityTableBody">
                                @if (Model.RecentActivities.Count == 0)
                                {
                                    <tr>
                                        <td colspan="5" class="text-center text-muted py-4">No recent activity found.</td>
                                    </tr>
                                }
                                else
                                {
                                    @foreach (var item in Model.RecentActivities)
                                    {
                                        <tr>
                                            <td class="ps-3">
                                                <span class="fw-medium">@item.DocumentName</span>
                                            </td>
                                            <td class="text-muted">@item.PatientName</td>
                                            <td>
                                                @{
                                                    var badgeClass = item.Action switch
                                                    {
                                                        "Uploaded" => "dash-badge-uploaded",
                                                        "Updated" => "dash-badge-updated",
                                                        "Archived" => "dash-badge-archived",
                                                        "Restored" => "dash-badge-restored",
                                                        "Deleted" => "dash-badge-deleted",
                                                        _ => "dash-badge-default"
                                                    };
                                                }
                                                <span class="dash-activity-badge @badgeClass">@item.Action</span>
                                            </td>
                                            <td class="text-muted">@item.Date.ToString("MMM dd, yyyy hh:mm tt")</td>
                                            <td class="text-muted">@item.PerformedBy</td>
                                        </tr>
                                    }
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // ─── Initial Data from Server ───
        var dashData = {
            monthlyTrend: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyUploadTrend.Select(m => m.Label))),
                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.MonthlyUploadTrend.Select(m => m.Count)))
            },
            docTypes: {
                labels: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DocumentTypeDistribution.Select(d => d.DocumentType))),
                data: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.DocumentTypeDistribution.Select(d => d.Count)))
            },
            activeArchived: {
                active: @Model.ActiveDocumentCount,
                archived: @Model.ArchivedDocumentCount
            }
        };

        // ─── Color Palette (max 3 primary) ───
        var colorPrimary = '#006d77';
        var colorAccent = '#83c5be';
        var colorPrimaryDark = '#005660';
        var colorBorder = '#d1d5db';
        var colorBg = '#edf6f9';
        var colorMuted = '#6b7280';
        var colorSurface = '#ffffff';

        // ─── Chart.js Defaults ───
        Chart.defaults.font.family = "system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";
        Chart.defaults.font.size = 12;
        Chart.defaults.color = colorMuted;

        // ─── 1. Monthly Document Upload Trend (Line) ───
        var trendCtx = document.getElementById('uploadTrendChart').getContext('2d');
        var trendChart = new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: dashData.monthlyTrend.labels,
                datasets: [{
                    label: 'Documents Uploaded',
                    data: dashData.monthlyTrend.data,
                    borderColor: colorPrimary,
                    backgroundColor: 'rgba(0, 109, 119, 0.08)',
                    borderWidth: 2.5,
                    pointBackgroundColor: colorPrimary,
                    pointBorderColor: colorSurface,
                    pointBorderWidth: 2,
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    tension: 0.35,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: colorPrimary,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 6,
                        padding: 10,
                        displayColors: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                        ticks: { precision: 0, padding: 8 },
                        border: { display: false }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { padding: 8 },
                        border: { display: false }
                    }
                }
            }
        });

        // ─── 2. Document Type Distribution (Bar) ───
        var typeCtx = document.getElementById('docTypeChart').getContext('2d');
        var typeChart = new Chart(typeCtx, {
            type: 'bar',
            data: {
                labels: dashData.docTypes.labels,
                datasets: [{
                    label: 'Documents',
                    data: dashData.docTypes.data,
                    backgroundColor: colorPrimary,
                    hoverBackgroundColor: colorPrimaryDark,
                    borderRadius: 6,
                    borderSkipped: false,
                    barPercentage: 0.55,
                    categoryPercentage: 0.7
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                indexAxis: 'y',
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: colorPrimary,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 6,
                        padding: 10,
                        displayColors: false
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                        ticks: { precision: 0, padding: 8 },
                        border: { display: false }
                    },
                    y: {
                        grid: { display: false },
                        ticks: { padding: 8 },
                        border: { display: false }
                    }
                }
            }
        });

        // ─── 3. Active vs Archived (Donut) ───
        var donutCtx = document.getElementById('activeArchivedChart').getContext('2d');
        var donutChart = new Chart(donutCtx, {
            type: 'doughnut',
            data: {
                labels: ['Active', 'Archived'],
                datasets: [{
                    data: [dashData.activeArchived.active, dashData.activeArchived.archived],
                    backgroundColor: [colorPrimary, colorAccent],
                    hoverBackgroundColor: [colorPrimaryDark, '#6bb5ac'],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '65%',
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 20,
                            usePointStyle: true,
                            pointStyleWidth: 10,
                            font: { size: 12 }
                        }
                    },
                    tooltip: {
                        backgroundColor: colorPrimary,
                        titleColor: '#fff',
                        bodyColor: '#fff',
                        cornerRadius: 6,
                        padding: 10,
                        displayColors: false,
                        callbacks: {
                            label: function(ctx) {
                                var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : 0;
                                return ctx.label + ': ' + ctx.raw + ' (' + pct + '%)';
                            }
                        }
                    }
                }
            },
            plugins: [{
                id: 'centerText',
                beforeDraw: function(chart) {
                    var ctx2 = chart.ctx;
                    var total = chart.data.datasets[0].data.reduce(function(a, b) { return a + b; }, 0);
                    var centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
                    var centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
                    ctx2.save();
                    ctx2.font = '600 22px system-ui, sans-serif';
                    ctx2.fillStyle = '#102a43';
                    ctx2.textAlign = 'center';
                    ctx2.textBaseline = 'middle';
                    ctx2.fillText(total, centerX, centerY - 8);
                    ctx2.font = '400 11px system-ui, sans-serif';
                    ctx2.fillStyle = '#6b7280';
                    ctx2.fillText('Total', centerX, centerY + 12);
                    ctx2.restore();
                }
            }]
        });

        // ─── Date Range Filter Logic ───
        var customDateFields = document.getElementById('customDateFields');

        document.querySelectorAll('.dash-filter-btn').forEach(function(btn) {
            btn.addEventListener('click', function() {
                var range = this.dataset.range;
                if (range === 'custom') {
                    // Show/hide custom date fields
                    if (customDateFields.style.display === 'none') {
                        customDateFields.style.display = 'flex';
                        setActiveFilter(this);
                    } else {
                        customDateFields.style.display = 'none';
                        this.classList.remove('active');
                        // Reset to All Time if hiding custom
                        var allTimeBtn = document.querySelector('[data-range="all"]');
                        setActiveFilter(allTimeBtn);
                        fetchDashboardData('all');
                    }
                    return;
                }
                // Hide custom date fields when other ranges are selected
                customDateFields.style.display = 'none';
                setActiveFilter(this);
                fetchDashboardData(range);
            });
        });

        document.getElementById('applyCustomDate').addEventListener('click', function() {
            var startDate = document.getElementById('customStartDate').value;
            var endDate = document.getElementById('customEndDate').value;
            if (!startDate || !endDate) return;
            if (new Date(startDate) > new Date(endDate)) {
                alert('Start date must be before end date.');
                return;
            }
            fetchDashboardData('custom', startDate, endDate);
        });

        function setActiveFilter(activeBtn) {
            document.querySelectorAll('.dash-filter-btn').forEach(function(b) { b.classList.remove('active'); });
            activeBtn.classList.add('active');
        }

        function fetchDashboardData(range, startDate, endDate) {
            var url = '@Url.Action("DashboardData", "Dashboard", new { area = "Staff" })';
            url += '?range=' + encodeURIComponent(range);
            if (startDate) url += '&startDate=' + encodeURIComponent(startDate);
            if (endDate) url += '&endDate=' + encodeURIComponent(endDate);

            // Show loading state on KPI numbers
            document.querySelectorAll('.dash-kpi-number').forEach(function(el) {
                el.style.opacity = '0.4';
            });

            fetch(url)
                .then(function(res) { return res.json(); })
                .then(function(data) {
                    updateKPIs(data);
                    updateCharts(data);
                    updateActivityTable(data.recentActivities);
                })
                .catch(function(err) {
                    console.error('Dashboard fetch error:', err);
                })
                .finally(function() {
                    document.querySelectorAll('.dash-kpi-number').forEach(function(el) {
                        el.style.opacity = '1';
                    });
                });
        }

        function updateKPIs(data) {
            animateNumber('kpiTotalDocs', data.totalDocuments);
            animateNumber('kpiTotalArchived', data.totalArchived);
            animateNumber('kpiTotalVersions', data.totalVersions);
            animateNumber('kpiDocsMonth', data.documentsUploadedThisMonth);
        }

        function animateNumber(id, target) {
            var el = document.getElementById(id);
            var current = parseInt(el.textContent) || 0;
            if (current === target) return;
            var steps = 20;
            var increment = (target - current) / steps;
            var step = 0;
            var timer = setInterval(function() {
                step++;
                if (step >= steps) {
                    el.textContent = target;
                    clearInterval(timer);
                } else {
                    el.textContent = Math.round(current + increment * step);
                }
            }, 25);
        }

        function updateCharts(data) {
            // Line chart + dynamic title
            if (data.trendTitle) {
                document.getElementById('trendChartTitle').textContent = data.trendTitle;
            }
            trendChart.data.labels = data.monthlyUploadTrend.map(function(m) { return m.label; });
            trendChart.data.datasets[0].data = data.monthlyUploadTrend.map(function(m) { return m.count; });
            trendChart.update('none');

            // Bar chart
            typeChart.data.labels = data.documentTypeDistribution.map(function(d) { return d.documentType; });
            typeChart.data.datasets[0].data = data.documentTypeDistribution.map(function(d) { return d.count; });
            typeChart.update('none');

            // Donut chart
            donutChart.data.datasets[0].data = [data.activeDocumentCount, data.archivedDocumentCount];
            donutChart.update('none');
        }

        function updateActivityTable(activities) {
            var tbody = document.getElementById('activityTableBody');
            var countEl = document.getElementById('activityCount');

            if (!activities || activities.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-4">No recent activity found.</td></tr>';
                countEl.textContent = 'No entries found';
                return;
            }

            countEl.textContent = 'Showing latest ' + activities.length + ' entries';
            var html = '';
            activities.forEach(function(item) {
                var badgeClass = 'dash-badge-default';
                switch (item.action) {
                    case 'Uploaded': badgeClass = 'dash-badge-uploaded'; break;
                    case 'Updated': badgeClass = 'dash-badge-updated'; break;
                    case 'Archived': badgeClass = 'dash-badge-archived'; break;
                    case 'Restored': badgeClass = 'dash-badge-restored'; break;
                    case 'Deleted': badgeClass = 'dash-badge-deleted'; break;
                }
                var date = new Date(item.date);
                var dateStr = date.toLocaleDateString('en-US', { month: 'short', day: '2-digit', year: 'numeric' })
                    + ' ' + date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });

                html += '<tr>' +
                    '<td class="ps-3"><span class="fw-medium">' + escapeHtml(item.documentName) + '</span></td>' +
                    '<td class="text-muted">' + escapeHtml(item.patientName) + '</td>' +
                    '<td><span class="dash-activity-badge ' + badgeClass + '">' + escapeHtml(item.action) + '</span></td>' +
                    '<td class="text-muted">' + dateStr + '</td>' +
                    '<td class="text-muted">' + escapeHtml(item.performedBy) + '</td>' +
                    '</tr>';
            });
            tbody.innerHTML = html;
        }

        function escapeHtml(text) {
            if (!text) return '';
            var div = document.createElement('div');
            div.appendChild(document.createTextNode(text));
            return div.innerHTML;
        }
    </script>
}

